@{
    ViewData["Title"] = "MSN|Stats";
}
@model RunDetailsVm




@{
    var grouped = Model.Calls.GroupBy(a => a.ResourceType);
    //.ToDictionary();
    var startTime = Model.Calls.Select(a => a.StartTime).First();


    var duplicates = Model.Calls.Where(a => a.Method == "GET")
        .GroupBy(i => i.Url)
        .Where(g => g.Count() > 1)
        .Select(g => g.Key);

}


<div class="container-fluid">
    <h1>Details</h1>
    <div class="row">
        <div class="col-lg-12">
            <h3>https://www.msn.com/</h3>
        </div>


    </div>

    <div class="row">
        @Model.StartTime | Total : <b>@Model.Calls.Count()</b> calls
    </div>

    
    @if (duplicates.Any())
    {
        <div class="row">
            <div class="col-lg-12">
                <div class="alert alert-danger" role="alert">
                    We noticed @duplicates.Count() duplicate GET calls from this page
                </div>
            </div>
            <div class="col-lg-12">
                <ul>


                    @foreach (var d in duplicates.OrderBy(a => a))
                    {
                        <li>@d</li>
                    }
                </ul>
            </div>
        </div>
    }

    <div class="row">
        <form asp-action="RunDetails" method="get">



            <SELECT asp-for="DisplayType" class="pull-right">
                <option value="grouped">Grouped by resource type</option>
                <option value="all">All</option>

            </SELECT>
        </form>

    </div>
    <div class="row">
        <div class="table-responsive">
            @if (Model.DisplayType == "grouped")
            {
                foreach (var k in grouped)
                {
                    <h3>@k.Key (@k.Count())</h3>

                    <table class="table table-striped table-condensed table-responsive">
                        <thead>
                            <tr>
                                <td>Method</td>
                                <td>Duration</td>

                                <td>Status</td>
                                <td>Type</td>
                                <td>Url</td>
                            </tr>
                        </thead>
                        @foreach (var run in k.OrderByDescending(a => a.Duration).ThenBy(a => a.Url))
                        {
                            <tr>
                                <td class="small">@run.Method</td>
                                <td class="small">
                                    <a asp-controller="Home" asp-action="DetailsForUrl" asp-route-url="@run.Url" title="Click to see details"> @run.Duration</a>
                                   
                                </td>


                                <td class="small">@run.Status</td>
                                <td class="small">@run.ResourceType</td>
                                <td class="small">
                                    <a asp-controller="Home" asp-action="DetailsForUrl" asp-route-url="@run.Url" title="Click to see details"> @run.Url</a>

                                </td>
                            </tr>
                        }
                    </table>
                }
            }
            else
            {

                <table class="table table-striped table-condensed table-responsive">

                    <thead>
                        <tr>
                            <td>Start Time</td>
                            <td>Method</td>
                            <td>Duration</td>

                            <td>Status</td>
                            <td>Type</td>
                            <td>Url</td>
                        </tr>
                    </thead>

                    @foreach (var run in Model.Calls.OrderByDescending(a => a.Duration).ThenBy(a => a.ResourceType))
                    {
                        <tr>
                            <td class="small">@run.StartTime.ToString("t")</td>
                            <td class="small">@run.Method</td>
                            <td class="small">
                                @run.Duration
                            </td>


                            <td class="small">@run.Status</td>
                            <td class="small">@run.ResourceType</td>
                            <td class="small">
                                @run.Url
                            </td>
                        </tr>
                    }
                </table>

            }
        </div>
    </div>
</div>


@section Scripts
    {
    <script>
        $(function () {
            $("#DisplayType").change(function () {
                $(this).closest("form").submit();
            });
        })
    </script>
}


